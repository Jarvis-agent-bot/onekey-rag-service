# frontend-admin 重构需求（按页面分组，深色工业感）

## 设计基调（深色工业感）
- 色板：背景深墨绿灰 (#0f1514)、炭黑(#0b0f10)，高亮酸橙黄绿(#b5ff66)，辅助线色石墨灰(#1e2628)。
- 字体：标题用硬朗几何无衬线（如 Barlow），正文用技术感清晰体（如 IBM Plex Sans），数字用等宽体。
- 细节：玻璃质感卡片 + 轻噪声背景，重阴影收敛到主卡片；动作强调“加载分组渐显 + Tab 滑动”。

## 术语说明（统一表述，避免缩写）
- 知识库：知识集合（后续不再用 KB 简称）。
- 数据源：采集入口，默认类型“网站爬虫（原 crawler_site）”。
- 抓取：从数据源获取页面。
- 索引：生成向量/检索结构。
- 页面/片段：页面与拆分后的内容块。
- 任务中心：抓取/索引/清理/评估等后台作业入口。

## 全局规范
- 导航分组：数据域（知识库、任务中心、页面搜索*可选*）、运营域（应用、质量与反馈、观测、审计）、系统域（总览、设置）。
- 组件：表单两列网格 + 分组标题，主行动按钮固定在视口底部浮条；表格支持行内折叠，批量操作浮层（复用 BulkActionsBar）。
- 空态/异常：语境化文案 + 快捷按钮（新建/重试/查看日志）。
- 动效：页面载入分组渐显；Tab 切换滑动；按钮/卡片 hover 高光。
- 监控时间窗：曲线默认 1h / 24h 快捷切换，支持自定义。

## 当前进度 / TODO（按页面）
- [x] 知识库列表：深色卡片视图 + 列表切换；新建向导 Step1-3（数据源类型、分段配置、调度确认）；支持搜索/引用提示。
- [x] 知识库详情：Tab 化（概览/数据源/文件批次/配置/调试）；数据源编辑、批次进度与文件展开；覆盖率进度条、引用应用卡片。
- [x] 任务中心：深色页头 + Tabs（任务列表 / 触发任务）；列表保留过滤/分页，展示 subtasks/logs；触发抓取/索引保持原参数校验。
- [x] 总览页：深色头部 + 概况卡（请求/覆盖率/任务/资源快照）+ 告警/任务提示。
- [x] 观测页：深色头部 + CPU/内存/网络/IO 曲线与时间窗切换，最新快照摘要。
- [x] 页面搜索：深色头部 + 筛选卡、批量重抓/删除入口。
- [x] 质量与反馈：页头/筛选重构，质量摘要与反馈列表保持。
- [x] 审计：页头/筛选重构，列表保持。
- [x] 设置：页头重构，配置/健康/测试保持。
- [x] 文件批次 chunk 预览：返回首段文本、chunk 数供前端展开验证。

## 页面级需求

### 1. 布局（AdminLayout）
- 侧边导航按域分组显示，当前所在页面高亮；移动端收起为抽屉。
- 顶部：工作区切换 + 全局搜索入口（预留）+ 快捷退出；显示当前“面包屑/域标签”。
- 背景：深色渐变 + 低频噪声；主内容宽度 1200px。

### 2. 总览页（DashboardPage）
- 卡片分区：运行概况、任务告警、质量提醒、观测 24h 摘要、系统资源。  
- 关键指标：总抓取数/失败数、索引覆盖率、任务运行中/排队/失败、反馈好评率、观测命中/错误率。  
- 动作：一键刷新；告警卡片附“去处理”跳转（任务中心/质量）。  
- 视觉：指标用等宽体，告警卡片用酸橙色边框。
- 细节：  
  - “最近抓取时间”“最后更新”突出显示；健康异常时顶置警示。  
  - 任务告警卡片列出前 3 条失败任务并可直接重试/跳转。  
  - 系统资源（容器优先，宿主机可选，曲线 1h/24h）：  
    - 容器指标：CPU（当前/限额，使用率曲线）、内存（使用/上限）、网络 RX/TX、块设备 IO（读/写带宽与延迟）、重启次数、运行时长、打开文件数/句柄、进程/线程数。  
    - 宿主机指标（若可读 /sys/fs/cgroup 与 /proc 或经 Sidecar/Node exporter 提供）：CPU/内存、根分区与数据卷磁盘占用与 inode、网络与块 IO。  
    - 权限与降级：默认展示容器；若无法读宿主机，显示“宿主机指标不可用”；指标读失败时给“采集失败/需挂载 /proc,/sys 或配置 exporter”提示。  
    - 采集策略：容器内走 cgroup v1/v2 + /proc；宿主机通过只读挂载或 Prometheus/Node exporter API；超过阈值高亮。

### 3. 知识库列表页（KbsPage）
- 卡片化列表：名称、ID、状态、页面/片段覆盖率、最近抓取时间、被应用引用数。  
- 批量入口：新建知识库按钮显眼；卡片内提供“查看详情”“最近任务”快捷。  
- 空态：说明知识库作用 + “创建并配置数据源”按钮。
- 新建向导（Step 1/2/3）：  
  - Step 1：选择数据源类型（文件导入、网站爬虫、空知识库）；文件导入支持拖拽/浏览，列出支持的格式与大小限制。  
  - Step 2：文档处理（分段规则、清洗、语言/编码、标题提取，预览片段示例）。  
  - Step 3：运行与完成（单次/调度触发、确认目标知识库、预览将生成的任务）。
- 细节：  
  - 卡片内展示“最新任务状态”徽标；失败高亮。  
  - 搜索与过滤：按名称/ID/状态/引用应用数范围过滤。  
  - 支持列表/卡片两种视图切换（可选）。  
  - 新建向导顶部展示步骤条（横向 Stepper），Step 1 卡片式数据源选择（文件导入/网站爬虫/空知识库），文件上传区支持拖拽、格式提示、大小上限提示。

### 4. 知识库详情（KbDetailPage → Tab 化）
- Tab：概览｜数据源｜抓取任务｜页面与片段｜配置｜调试。
- 概览：统计（页面、片段、覆盖率）、引用的应用列表、最近 3 条任务状态、最近一次抓取/索引时间。
- 数据源：  
  - 列表：名称、类型（网站爬虫/文件导入）、状态、更新时间。  
  - 编辑：表单分组（必填/高级），模板一键填充；右侧 JSON 预览（只读或高级模式）。  
  - 校验：必填缺失高亮，保存前显示变更摘要；删除需二次确认。  
- 抓取任务：页内触发单次/批量抓取；展示最近 N 次结果（耗时、成功/失败、日志入口）；支持按数据源过滤。  
- 页面与片段：覆盖率、失败率、变更检测（changed=true），预设过滤（http_status、indexed、数据源）；批量重抓按钮。  
- 配置：知识库专属配置表单化（字段说明+默认值）；JSON 仅做高级预览；保存展示 Diff；删除知识库的危险操作单独卡片。支持提示词模板覆盖（请求模板、回答模板），优先级高于全局。  
- 调试：只读原始 JSON、接口示例；与可写表单分离。
- 细节：  
  - 概览卡片显示“采集链路进度”：数据源就绪 → 最近抓取 → 最近索引 → 覆盖率；若缺失步骤用提示状态。  
  - 数据源表单：字段下方给出示例（如基础 URL、站点地图、包含/排除规则）；高级字段折叠。  
  - 页面与片段：列表支持展开查看差异（变更内容摘要/哈希变化）；提供“仅显示有变更”“仅失败”快速筛选。  
  - 抓取任务：运行中展示实时进度与估时；失败行给出错误摘要与日志链接。  
  - 配置：保存按钮固定底部浮条，显示未保存提示；支持“重置为服务端配置”。  
  - 数据源字段补充：  
    - 网站爬虫：基础 URL、站点地图、包含/排除规则、最大页数、并发/延迟、UA/Headers、登录/Token（可选）。  
    - 文件导入：上传文件列表（支持 MD/PDF/DOCX/CSV/HTML 等，大小/数量上限）、拆分策略（分段长度/重叠）、编码与语言、标题提取、表格/图片处理开关。

### 5. 页面搜索（PagesPage，全局入口可选）
- 若保留独立页：提供跨知识库/数据源搜索；过滤项与知识库内一致。  
- 提供“回到知识库详情”按钮，保持链路连贯。
- 细节：  
  - 支持关键词高亮、HTTP 状态色标；分页浮动条保持可见。  
  - 批量操作：批量重抓、批量删除；操作后给出影响统计。

### 6. 任务中心（JobsPage）
- 分组视图：按类型（抓取/索引/清理/评估）分栏或 Tab；每组显示数量徽标。  
- 进度：  
  - 任务行显示百分比（已处理/总数）、耗时、剩余预估；加载中用进度条/环形进度。  
  - 运行中任务支持实时刷新（轮询）与状态标签（排队/运行/暂停/失败/成功）。  
  - 批量任务显示成功/失败计数与展开明细。  
- 过滤：预设“最近失败”“进行中”，支持按知识库、数据源、时间范围过滤。  
- 操作：重试/终止/查看日志；行内展示来源知识库与数据源（可点击回跳）。  
- 批量：多选后批量重试；提供“回到来源知识库”按钮。

### 7. 质量与反馈（QualityPage / FeedbackPage）
- 质量：展示命中率、错误率、延迟分布；按知识库/应用过滤；异常高亮卡片。  
- 反馈：列表好评/差评，聚合趋势；支持筛选到具体知识库关联的应用/模型；提供“查看上下文”入口。
- 细节：  
  - 质量卡片支持对比最近 7 天趋势；异常点可点击查看对应任务/请求样本。  
  - 反馈列表提供“相似反馈聚合”视图，快速定位常见问题。

### 8. 观测（ObservabilityPage）
- 24h 摘要：请求量、错误率、命中率、延迟（p95/平均）。  
- 细分：按模型/知识库/应用拆分；图表深色网格线 + 酸橙高亮曲线。  
- 跳转：异常段落链接到任务中心或质量页。
- 细节：  
  - 时间范围切换（1h/24h/7d）；支持导出 CSV。  
  - 图表支持悬浮提示详细指标；异常阈值可自定义。  
  - 进度：metrics 接口返回容器 CPU/内存/网络/磁盘 IO 快照（timeseries 当前用滑动窗口）；前端已绘制 CPU/内存/网络/IO 曲线和降级提示；宿主机指标仍为占位。

### 9. 审计（AuditPage）
- 记录：时间、操作者、动作、目标（知识库/数据源/任务），结果状态。  
- 过滤：时间范围、操作者、动作类型；提供导出。  
- 视觉：紧凑表格 + 状态标签。
- 细节：  
  - 行内可展开查看变更摘要（前后对比）；失败操作高亮。  
  - 支持按目标类型（知识库/数据源/任务/设置）过滤。

### 10. 设置（SettingsPage）
- 分组：模型、检索、作业、监控。  
- 表单化：字段说明+默认值；敏感信息不回显；高级 JSON 预览只读。  
- 测试卡片：一键测试（LLM/向量/重排），展示耗时与结果/错误；测试输入可编辑。  
- 健康检查：状态卡片 + 依赖 JSON 折叠。
- 细节：  
  - 模型区域支持“选择常用预设”一键填充；校验必填字段。  
  - 作业配置区显示当前并发/重试策略，允许快速调优。  
  - 监控配置区提供告警阈值输入，并显示最近触发记录。  
  - 全局提示词模板：配置上游 API 请求模板与回答模板（含变量占位，如 user_query、retrieved_context），作为默认值；知识库配置可覆盖。

#### 提示词模板变量（建议设计，知识库级优先，移除全局）
- 基础上下文：`user_query`（用户问题原文）、`retrieved_context`（拼接后的上下文）、`sources_inline`（引用编号列表）、`workspace_name` / `app_name`、`kb_names`（匹配的知识库名称数组）。
- 检索信息：`retrieval_query`（重写后的检索词）、`top_k`（上下文条数）、`inline_citation_enabled`（布尔，要求 [n] 引用时为 true）。
- 对话与记忆：`history_excerpt`（近期对话）、`memory_summary`（长程摘要）。
- 模型参数：`model_name`、`temperature`、`top_p`、`max_tokens`。
- 响应规则：`formatting_rules`（格式要求片段）、`safety_rules`（不编造/引用规则片段）。
- 可选：`locale`（语言偏好）、`timestamp`、`request_id`（便于日志）。

说明：
- 全局模板提供默认 system/user 结构；知识库可部分覆盖（如仅覆盖 user），优先级“知识库 > 全局”。
- 模板支持 JSON/文本两种：请求模板用于拼装 messages；回答模板用于后处理（可选）。
- 占位符缺失时自动删除所在行或替换为空，避免残留变量名。

#### 提示词模板落地（需后端改造，取消全局层级）
- 配置存储：知识库表增加模板字段（system/user/后处理，可分区段）；不再提供全局模板，默认值为内置硬编码，建议迁移到配置存储以便维护。  
- API：  
  - GET/PUT 知识库模板 `/admin/api/workspaces/{ws}/kbs/{kb}/prompt-template`。  
  - 预览渲染 `/admin/api/workspaces/{ws}/kbs/{kb}/prompt-template/render`（输入变量，返回 messages）。  
- 生效逻辑：  
  - 请求时读取知识库模板；缺失部分回退到默认模板（建议将硬编码迁移为“系统默认模板”存储）。  
  - 占位符替换后清理空行；若启用 inline citation，根据 settings.inline_citations_enabled 注入引用提示。  
- 前端：  
  - 知识库详情-配置：模板编辑/预览/一键重置为系统默认；提供变量白名单帮助。  
  - 移除“全局模板”入口，保持与 Dify 层级一致。

#### 文件导入（需前后端联动）
- 支持格式：MD、PDF、DOCX、TXT、CSV、HTML 等；单文件大小上限与总数限制；上传进度与失败重试。  
- 后端：新增文件上传接口、存储（本地/对象存储）与解析队列；解析产物进入“文档处理”步骤（分段/清洗）。  
- 前端：Step 1 拖拽上传 + 校验提示；Step 2 预览拆分后的片段示例；Step 3 触发索引/调度。

文件导入 API 形状（建议）：
- `POST /admin/api/workspaces/{ws}/kbs/{kb}/files`：multipart 上传，返回 file_batch_id；校验格式/大小/数量。  
- `GET /admin/api/workspaces/{ws}/kbs/{kb}/files/{batch_id}`：查看上传批次状态（待解析/解析中/完成/失败），含文件列表、错误信息。  
- `POST /admin/api/workspaces/{ws}/kbs/{kb}/files/{batch_id}/process`：提交解析+分段任务，传入分段/清洗参数；返回 job_id。  
- `GET /admin/api/jobs/{job_id}`：查看处理进度与日志。  
- 可选：`DELETE /admin/api/workspaces/{ws}/kbs/{kb}/files/{batch_id}` 取消/清理。

#### 任务中心补充
- 轮询与日志：运行中任务按固定频率轮询；行内“查看日志/明细”弹出层；批量任务显示子任务列表与成功/失败计数。  
- 操作策略：失败可重试，运行中可终止/暂停（若后端支持）；显示任务来源（知识库/数据源/文件批次）。  
- 进度估算：已处理/总数，按速率估算剩余时间；长任务提供“刷新/隐藏”选项。

#### 观测/总览指标降级策略
- 容器指标必备；宿主机指标若缺权限则只显示容器并提示“宿主机指标不可用”。  
- 若无法读取 /proc 或 /sys（cgroup），展示静态提示；可配置 Sidecar/Node exporter 数据源以补宿主机指标。

#### 质量与反馈补充
- 评测入口：手动评测与自动评测（选取样本对话，对结果打分）；支持导出评测结果。  
- 对话复盘：可查看上下文、模型响应、引用片段，支持标注“是否正确/是否编造”。  
- 聚合：常见问题聚类/标签，跳转到对应知识库或数据源。

#### 文档处理细节（Step 2）
- 分段：长度/重叠、按标题/段落分割开关。  
- 清洗：去除导航/页脚、去噪、编码/语言选择。  
- 标题提取：基于 H1-H3 或文件元数据。  
- 表格/图片：是否提取表格为 Markdown，图片占位策略。  
- 预览：展示若干拆分后的片段与引用路径。

#### 后端改造点汇总
- 提示词模板：知识库模板存储、读写 API、渲染合成逻辑、占位符清理；支持预览/测试接口；硬编码默认模板迁出。  
- 文件导入：上传存储、解析管线（异步队列）、拆分/清洗配置入参；与知识库/任务队列打通，支持进度与失败重试。  
- 系统资源：容器内 cgroup 采集；如需宿主机指标，支持从只读 /proc,/sys 或 Node exporter 拉取。  
- 任务中心：API 提供进度（已处理/总数）、日志/子任务明细、暂停/重试操作；轮询接口与状态机。  
- 观测：若接入 Prometheus/Node exporter，提供代理或直连配置；否则提示降级。  
- 质量与反馈：评测/标注接口、样本回放、聚合查询。  
- 配置接口：知识库/数据源字段扩展（文件导入相关）、文档处理参数、模板覆盖字段。

任务进度 API 形状（建议）：
- `GET /admin/api/jobs`：支持过滤（type/status/kb_id/source_id/date_range），返回简要列表（id、type、status、progress、updated_at）。  
- `GET /admin/api/jobs/{job_id}`：返回进度（已处理/总数、百分比、估计剩余）、子任务明细、错误列表、日志片段。  
- `POST /admin/api/jobs/{job_id}/retry`：重试失败任务；`POST /admin/api/jobs/{job_id}/cancel`：取消/终止（若支持）；`POST /admin/api/jobs/{job_id}/pause|resume`（可选）。  
- 轮询策略：前端对运行中任务定期轮询；失败/完成后停止。

提示词模板默认值迁移（建议）：
- 现有硬编码 system/user 模板从代码迁出为“系统默认模板”存储；知识库模板为空时回退默认模板。  
- 允许在管理后台更新默认模板（仅维护用），但不暴露为“全局生效”概念，保持与 Dify 的知识库/应用层级一致。

### 11. 登录页
- 深色背景 + 品牌标题；输入框高对比度；错误提示明显。  
- 成功后跳转总览，若有来源路径则回跳。
- 细节：  
  - 支持键盘回车提交；错误消息与输入框绑定显示。  
  - 提供“忘记/重置 Token”说明链接（若有）。

## 技术与实现注意
- 主题变量：通过 CSS 变量抽象色板/阴影/半径/动效；Tailwind 配置深色为默认。  
- 字体加载：首屏预加载标题/正文/等宽体。  
- 兼容：保持现有 hash router 链接有效；旧路由跳转到新的 Tab/页面。  
- 校验：表单校验与 JSON 校验并存，错误提示靠近字段。

## 测试与验收
- 关键流程 E2E：新建知识库向导、数据源保存、触发抓取、批量重抓、配置保存校验、模型测试。  
- 视觉回归：关键页截图基线（总览、知识库详情-数据源/配置、任务中心、设置）。  
- 性能：首屏加载与长表格交互延迟监测（必要时引入虚拟滚动）。

## Sprint 拆分（建议 4 个迭代）

### Sprint 1：模板与文件链路打底
- 进度：  
  - 知识库模板：后端已提供 GET/PUT/render 接口，pipeline 支持知识库模板覆盖默认文案（优先级最高 KB），占位符缺失自动置空。  
  - 文件上传：后端已提供文件批次上传/查询/触发处理 API；worker 现可读取文本文件、生成页面并索引为 chunks（简单解码），失败文件记录到 progress；落盘临时目录。  
  - 依赖待安装：本地导入因缺少 pgvector 未跑通；需在容器内安装 requirements 后自测接口。  
- 后端：知识库级提示词模板存储与渲染 API（移除全局层级，硬编码迁为默认模板）；文件上传/批次状态/触发处理 API；任务进度 API（列表/详情/重试/取消/轮询）。  
- 前端：知识库详情配置 Tab 增加模板编辑/预览；新建向导 Stepper（Step1 数据源选择含文件上传，Step2 文档处理选项，Step3 触发）；任务中心进度条与日志弹层基础。  
- 风险/验证：占位符清理正确；文件大小/类型校验；任务进度轮询停止条件。

**涉及文件与改法（S1）**
- 后端核心：
  - `src/onekey_rag_service/rag/pipeline.py`：移除硬编码模板；改为读取“默认模板”与“知识库模板”合成；占位符清理。  
  - `src/onekey_rag_service/admin/api/...`（新增）：知识库模板 CRUD、模板渲染预览接口；文件上传/批次状态/触发处理接口；任务进度/重试/取消接口。  
  - `src/onekey_rag_service/models.py` & migrations：KB 增加模板字段；文件批次/文件表；任务子任务表（如需）。  
  - `src/onekey_rag_service/worker.py`：队列消费文件解析任务；任务进度上报。  
  - `src/onekey_rag_service/rag/conversation.py`（若有）：模板变量注入辅助。
- 前端核心：
  - 路由：`frontend-admin/src/router.tsx`（保持）；  
  - 知识库：`frontend-admin/src/views/KbsPage.tsx`（向导 Stepper UI）；`frontend-admin/src/views/KbDetailPage.tsx`（配置 Tab 增加模板编辑/预览）；  
  - 任务中心：`frontend-admin/src/views/JobsPage.tsx`（进度条、日志弹层、轮询）。  
  - 组件：新增 Stepper/上传/模板编辑组件，放在 `frontend-admin/src/components/`。

**步骤（S1）**
1) 数据模型与迁移：KB 表加模板字段；新增文件批次/文件表；任务子任务表（可选）。  
2) 后端 API：模板 CRUD+渲染、文件上传+批次状态+处理触发、任务进度/重试/取消。  
3) Pipeline 调整：读取模板、占位符替换、回退默认模板；硬编码迁移为“默认模板存储”。  
4) 前端向导与模板 UI：实现 Stepper + 文件上传 + 文档处理选项；配置 Tab 模板编辑/预览；任务中心进度/日志基础。  
5) 自测：  
   - 单元：模板渲染函数、文件上传校验。  
   - 接口：模板 CRUD/渲染、文件上传/处理触发、任务进度。  
   - 前端：创建知识库（文件导入）、查看任务进度、模板保存/预览。

### Sprint 2：数据源/页面/任务闭环
- 后端：文件解析/分段/清洗管线接入队列；数据源字段扩展（文件导入、网站爬虫高级字段）；任务子任务明细。  
- 前端：数据源表单分组+示例，文件导入批次状态、分段预览；页面与片段 Tab 支持变更筛选、批量重抓；任务中心子任务展开。  
- 风险/验证：长批次进度估算、失败重试可用；批量操作的并发/回退。
  - 进度：worker 已能读取文本文件生成页面并索引为 chunks，返回 failed_files 与 logs；任务详情接口返回 subtasks/logs。非文本/PDF/DOCX 仍未支持。

**涉及文件与改法（S2）**
- 后端：  
  - `src/onekey_rag_service/crawler/` & `indexing/`：补文件解析/分段/清洗逻辑，支持配置入参。  
  - `admin/api`：数据源字段扩展（网站爬虫高级、文件导入参数），任务详情返回子任务明细。  
  - `worker.py`：分段/索引任务上报子任务进度。  
- 前端：  
  - `KbsPage.tsx`/`KbDetailPage.tsx`：数据源字段扩展 UI、文件批次状态与分段预览；  
  - `PagesPage.tsx` 或 KbDetail Tab：变更筛选/批量重抓；  
  - `JobsPage.tsx`：子任务展开、失败明细。

**步骤（S2）**
1) 扩展数据源模型与后端校验；  
2) 文件解析/分段/清洗管线对接队列与任务上报；  
3) 前端数据源表单与预览、页面/片段筛选与批量操作；  
4) 任务中心子任务/失败明细展示；  
5) 自测：长批次进度、批量重抓、数据源保存/回填。

### Sprint 3：观测与系统资源
- 后端：容器 cgroup 采集，若可用则接宿主机（/proc,/sys 或 Node exporter）；观测接口补 1h/24h/7d 聚合。  
- 前端：总览/观测页曲线（CPU/内存/网络/IO/磁盘）、阈值高亮、降级提示；时间窗切换。  
- 风险/验证：无权限场景的兜底提示；采集频率对性能的影响。
  - 进度：新增 `/admin/api/workspaces/{ws}/metrics`（容器 cgroup + 可选 node_exporter 占位），返回降级标记；前端未接入。

**涉及文件与改法 (S3)**
- 后端：  
  - 新增资源采集模块（如 `observability/system_metrics.py`），容器 cgroup 读取；可选 Node exporter 客户端；  
  - `admin/api/observability`：曲线数据接口（1h/24h/7d）。  
- 前端：  
  - `DashboardPage.tsx`、`ObservabilityPage.tsx`：曲线图、阈值高亮、降级提示、时间窗切换组件。

**步骤（S3）**
1) 实现容器指标采集与接口；可选接入宿主机/Node exporter；  
2) 前端曲线与降级提示；  
3) 自测：无权限/失败场景提示、采集频率对性能影响。

### Sprint 4：质量/反馈与打磨
- 后端：评测/标注接口、样本回放、聚合查询；可选成本/计价补充。  
- 前端：质量与反馈页的评测入口、聚合视图；UI/动效统一、空态/错误态完善；视觉回归基线截图。  
- 风险/验证：评测数据量的查询性能；UI 与主题一致性。

**涉及文件与改法 (S4)**
- 后端：  
  - `admin/api/quality`/`feedback`：评测/标注/聚合接口；  
  - 存储/查询层：新增评测结果表或复用反馈表扩展字段。  
- 前端：  
  - `QualityPage.tsx`、`FeedbackPage.tsx`：评测入口、标注、聚合视图、回放对话。  
  - 全局样式与动效统一。

**步骤（S4）**
1) 评测/标注数据模型与接口；  
2) 前端评测/标注/聚合视图；  
3) 视觉与动效统一、空态/错误态完善；  
4) 自测：评测查询性能、视觉回归基线截图更新。

## 通用测试策略
- 单元：模板渲染、文件解析/分段、资源采集、任务状态机。  
- 接口：按 Sprint 覆盖新增 API（CRUD、进度、日志、渲染、观测）。  
- 前端：关键用户流 E2E（新建知识库-文件导入-触发任务-查看进度-使用模板回复）、观测曲线降级、评测标注流。  
- 视觉：关键页截图回归；主题一致性检查。  
- 性能：长批次、长列表、指标采集频率对延迟影响。
